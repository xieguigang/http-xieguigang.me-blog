<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>The Action Interceptor Pattern | 拾荒者</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="source: http://www.codeproject.com/Articles/1104555/The-Action-Interceptor-Pattern?msg=5258531#xx5258531xx

IntroductionIn Interceptor in the Wild by João Matos Silva has presented how to use an IoC">
<meta property="og:type" content="article">
<meta property="og:title" content="The Action Interceptor Pattern">
<meta property="og:url" content="http://yoursite.com/2016/06/09/action_interceptor_pattern/index.html">
<meta property="og:site_name" content="拾荒者">
<meta property="og:description" content="source: http://www.codeproject.com/Articles/1104555/The-Action-Interceptor-Pattern?msg=5258531#xx5258531xx

IntroductionIn Interceptor in the Wild by João Matos Silva has presented how to use an IoC">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/Class.png">
<meta property="og:updated_time" content="2016-06-09T19:02:33.332Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="The Action Interceptor Pattern">
<meta name="twitter:description" content="source: http://www.codeproject.com/Articles/1104555/The-Action-Interceptor-Pattern?msg=5258531#xx5258531xx

IntroductionIn Interceptor in the Wild by João Matos Silva has presented how to use an IoC">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/Class.png">
  
    <link rel="alternative" href="/atom.xml" title="拾荒者" type="application/atom+xml">
  
  
    <link rel="icon" href="http://xieguigang.me/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars1.githubusercontent.com/u/9410171?v=3&amp;s=460" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">しゃけい よしつな</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="http://xieguigang.me/">HOME</a></li>
				        
							<li><a href="/archives">Archives</a></li>
				        
							<li><a href="/nuget">Works</a></li>
				        
							<li><a href="/about">About</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/xieguigang" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/ineat" title="weibo">weibo</a>
					        
								<a class="mail" target="_blank" href="mailto://I@xieguigang.me" title="mail">mail</a>
					        
								<a class="twitter" target="_blank" href="https://twitter.com/xieguigang" title="twitter">twitter</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/3d-graphics/" style="font-size: 10px;">3d graphics</a> <a href="/tags/CodeProject/" style="font-size: 14px;">CodeProject</a> <a href="/tags/Desktop/" style="font-size: 10px;">Desktop</a> <a href="/tags/GCModeller/" style="font-size: 10px;">GCModeller</a> <a href="/tags/Linq/" style="font-size: 10px;">Linq</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/SDK-document/" style="font-size: 10px;">SDK document</a> <a href="/tags/Syntax/" style="font-size: 10px;">Syntax</a> <a href="/tags/UI/" style="font-size: 10px;">UI</a> <a href="/tags/WPF/" style="font-size: 10px;">WPF</a> <a href="/tags/XAML/" style="font-size: 10px;">XAML</a> <a href="/tags/YAML/" style="font-size: 10px;">YAML</a> <a href="/tags/architecture/" style="font-size: 12px;">architecture</a> <a href="/tags/circos/" style="font-size: 12px;">circos</a> <a href="/tags/d3js/" style="font-size: 12px;">d3js</a> <a href="/tags/data-visualization/" style="font-size: 10px;">data visualization</a> <a href="/tags/document/" style="font-size: 10px;">document</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/language/" style="font-size: 10px;">language</a> <a href="/tags/libzplay/" style="font-size: 10px;">libzplay</a> <a href="/tags/music/" style="font-size: 12px;">music</a> <a href="/tags/my-works/" style="font-size: 10px;">my works</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/note/" style="font-size: 18px;">note</a> <a href="/tags/perl/" style="font-size: 10px;">perl</a> <a href="/tags/re0/" style="font-size: 10px;">re0</a> <a href="/tags/rem/" style="font-size: 10px;">rem</a> <a href="/tags/repost/" style="font-size: 12px;">repost</a> <a href="/tags/svg/" style="font-size: 10px;">svg</a> <a href="/tags/tricks/" style="font-size: 10px;">tricks</a> <a href="/tags/vb-net/" style="font-size: 20px;">vb.net</a> <a href="/tags/works/" style="font-size: 10px;">works</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a> <a href="/tags/前端设计/" style="font-size: 14px;">前端设计</a> <a href="/tags/架构设计/" style="font-size: 10px;">架构设计</a> <a href="/tags/转载搬运/" style="font-size: 16px;">转载搬运</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://codeproject.com/">Code Project</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://gcmodeller.org/">GCModeller</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">大神在此！</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">しゃけい よしつな</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="https://avatars1.githubusercontent.com/u/9410171?v=3&amp;s=460" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">しゃけい よしつな</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="http://xieguigang.me/">HOME</a></li>
		        
					<li><a href="/archives">Archives</a></li>
		        
					<li><a href="/nuget">Works</a></li>
		        
					<li><a href="/about">About</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/xieguigang" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/ineat" title="weibo">weibo</a>
			        
						<a class="mail" target="_blank" href="mailto://I@xieguigang.me" title="mail">mail</a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/xieguigang" title="twitter">twitter</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-action_interceptor_pattern" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/09/action_interceptor_pattern/" class="article-date">
  	<time datetime="2016-06-08T16:00:00.000Z" itemprop="datePublished">2016-06-09</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      The Action Interceptor Pattern
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CodeProject/">CodeProject</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/architecture/">architecture</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/note/">note</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vb-net/">vb.net</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/转载搬运/">转载搬运</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>source: <a href="http://www.codeproject.com/Articles/1104555/The-Action-Interceptor-Pattern?msg=5258531#xx5258531xx" target="_blank" rel="external">http://www.codeproject.com/Articles/1104555/The-Action-Interceptor-Pattern?msg=5258531#xx5258531xx</a></p>
</blockquote>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In Interceptor in the Wild by João Matos Silva has presented how to use an IoC framework, NInject, to inject new behaviors into existing methods without hacking into the method implementations. In this article, we will see an old-school yet beneficial way to reach the same goal, but without messing around with IoC frameworks.</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/Class.png" alt=""></p>
<a id="more"></a>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><blockquote>
<p><strong>Notice:</strong><br>The article Interceptor in the Wild by João Matos Silva was very well written and pleased to follow. This article offers the alternative to it and reuses examples in it. I suggest you read it before going on with this alternative.</p>
</blockquote>
<p>In Silva’s article, the good sides of IoC frameworks were demonstrated. However, there are pros and cons in IoC frameworks in practical use. Please correct me if any of the following listed is wrong.</p>
<ol>
<li><strong>Abstraction of object creation</strong><ul>
<li><strong>Pros</strong>: Dynamic object factory can be achieved at runtime.</li>
<li><strong>Cons</strong>:<br>  a. It hides the constructor of the types, which may be difficult for programmers to follow when the injection chains become complicated.<br>  “What instance is resolved by the IoC?” is one of the most common issue programmers will usually encounter.<br>  b. It requires some efforts when we try to instantiate objects, if we are trying to call:<br>  [<strong>b1</strong>] <em>Constructors with parameters: relative discussions here and there. And this can usually causes problems when the programmers are refactoring the constructor,<br>  without knowing that it is somewhere referenced by the IoC module indirectly.</em><br>  [<strong>b2</strong>] <em>Private or internal constructors: relative discussion here and there.</em><br>  [<strong>b3</strong>] <em>Constructors which could throw exceptions, and we have to work harder to address them.</em><br>  c. <strong>Performance penalty</strong>.</li>
</ul>
</li>
<li><strong>Runtime parameterization</strong>. It is not so easy to alter the parameter of interceptors in IoC. And again, performance penalty here is unavoidable.</li>
<li><strong>Partially overlapped interception</strong>: An IoC binder affects all methods bounded to the type via the given interface. Given that we have a type with three methods: M1, M2 and M3, and we are going to use all of them in the code. We want to bind behavior B1 to M1, B1 and B2 to M2, but no behavior to M3. Afterwards, we are going to call the bounded M1, bounded M2, and the unbounded M3. You need to write a lot to achieve this. It is not so easy to implement, understand or debug with IoC frameworks at all.</li>
<li>IoC binders only affect instance methods, not static methods, unless you wrap them with instance classes.</li>
<li><strong>Complexity</strong>. IoC requires the programmer to program new classes or interfaces for behavioral interceptors, thus more types have to be added to the project.</li>
</ol>
<h2 id="An-Alternative-to-IoC-Injections"><a href="#An-Alternative-to-IoC-Injections" class="headerlink" title="An Alternative to IoC Injections"></a>An Alternative to IoC Injections</h2><p>If injecting functionalities to methods is our goal, and the above issues in IoC frameworks are your headache, the Action Interceptor Pattern is your way to go. The following is an example of an Action Interceptor. It can be as simple as the following five lines:</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;Extension&gt;</span><br><span class="line"><span class="keyword">Public</span> <span class="keyword">Function</span> WaitAMinute(<span class="keyword">Of</span> TArg, TResult)(func <span class="keyword">As</span> Func(<span class="keyword">Of</span> TArg, TResult)) <span class="keyword">As</span> Func(<span class="keyword">Of</span> TArg, TResult)</span><br><span class="line">    <span class="keyword">Return</span> <span class="keyword">Function</span>(arg)</span><br><span class="line">               <span class="keyword">Call</span> Thread.Sleep(TimeSpan.FromMinutes(<span class="number">1</span>))</span><br><span class="line">               <span class="keyword">Return</span> func(arg)</span><br><span class="line">           <span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br></pre></td></tr></table></figure>
<p>You may ask: What? An extension method of Func?</p>
<p>Yep! Wrapping a function with another function, and the job will be done. Just a single method will save our days. Not yet convinced? Please read on.</p>
<h2 id="The-Usage-of-Action-Interceptors"><a href="#The-Usage-of-Action-Interceptors" class="headerlink" title="The Usage of Action Interceptors"></a>The Usage of Action Interceptors</h2><p>I will use the NativeClient example in Interceptor in the Wild to demonstrate how Action Interceptors can be an alternative to IoC injections.</p>
<h3 id="Decreasing-Fault-Rate-Increasing-Success-Rate"><a href="#Decreasing-Fault-Rate-Increasing-Success-Rate" class="headerlink" title="Decreasing Fault Rate / Increasing Success Rate"></a>Decreasing Fault Rate / Increasing Success Rate</h3><p>In the Silva’s article Interceptor in the Wild, the NativeClient very well shows us a service which can be broken at any time, and the RetryInterceptor remedies this by retrying when something goes wrong. The same pattern can be implemented with Action Intercetor.</p>
<p>To demonstrate the result. Let’s take a look back to the primitive client code:</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Const</span> TimesToInvoke <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">1000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Public</span> <span class="keyword">Sub</span> Main(args <span class="keyword">As</span> <span class="built_in">String</span>())</span><br><span class="line">    <span class="keyword">Dim</span> counter = <span class="keyword">New</span> StatsCounter()</span><br><span class="line">    <span class="keyword">Dim</span> client = <span class="keyword">New</span> NaiveClient(counter)</span><br><span class="line">    </span><br><span class="line">    counter.Stopwatch.Start()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">For</span> i <span class="keyword">As</span> var = <span class="number">0</span> <span class="keyword">To</span> TimesToInvoke - <span class="number">1</span></span><br><span class="line">        <span class="keyword">Try</span></span><br><span class="line">            client.GetMyDate(DateTime.Today.AddDays(i <span class="keyword">Mod</span> <span class="number">30</span>))</span><br><span class="line">            counter.TotalSuccess += <span class="number">1</span></span><br><span class="line">        <span class="keyword">Catch</span> ex <span class="keyword">As</span> Exception</span><br><span class="line">            counter.TotalError += <span class="number">1</span></span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Try</span></span><br><span class="line">    <span class="keyword">Next</span></span><br><span class="line">	</span><br><span class="line">    counter.Stopwatch.[<span class="keyword">Stop</span>]()</span><br><span class="line">    counter.PrintStats()</span><br><span class="line">    Console.WriteLine(<span class="string">"Press any key to exit"</span>)</span><br><span class="line">    Console.ReadKey()</span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure>
<p>In the above code, you don’t need to care about how GetMyDate was implemented, since we will not touch it and we will just change the client side code which calls that function. Please just keep in mind that it was a broken function and it had a probability of 0.3 to throw exceptions.</p>
<p>The result of execution was, at no doubt, very bad. It took a long time to run and execution fail rates were as high as 325/1000. Here was a possible output.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Execution Time: 36.0658004 seconds</span><br><span class="line">Total Executions: 1000</span><br><span class="line">Execution Sucess: 675</span><br><span class="line">Total Sucess: 675</span><br><span class="line">Execution Fail: 325</span><br><span class="line">Total Fail: 325</span><br></pre></td></tr></table></figure>
<p>Now, we will introduce a new RetryIfFailed action interceptor to automatically retry the action after failures, and we can easily configure how many times we want to retry at run time. by assigning value to the maxRetry parameter.</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;Extension&gt;</span><br><span class="line"><span class="keyword">Public</span> <span class="keyword">Function</span> RetryIfFailed(<span class="keyword">Of</span> TArg, TResult)(func <span class="keyword">As</span> Func(<span class="keyword">Of</span> TArg, TResult), maxRetry <span class="keyword">As</span> <span class="built_in">Integer</span>) <span class="keyword">As</span> Func(<span class="keyword">Of</span> TArg, TResult)</span><br><span class="line">    <span class="keyword">Return</span> _</span><br><span class="line">        <span class="keyword">Function</span>(arg)</span><br><span class="line">            <span class="keyword">Dim</span> t <span class="keyword">As</span> <span class="keyword">New</span> Pointer(Scan0)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">Do</span></span><br><span class="line">                <span class="keyword">Try</span></span><br><span class="line">                    <span class="keyword">Return</span> func(arg)</span><br><span class="line">                <span class="keyword">Catch</span> generatedExceptionName <span class="keyword">As</span> Exception</span><br><span class="line">                    <span class="keyword">If</span> ++t &gt; maxRetry <span class="keyword">Then</span></span><br><span class="line">                        <span class="keyword">Throw</span></span><br><span class="line">                    <span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">                <span class="keyword">End</span> <span class="keyword">Try</span></span><br><span class="line">            <span class="keyword">Loop</span> <span class="keyword">While</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br></pre></td></tr></table></figure>
<p>Then, we apply it to the calling procedure.</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Dim</span> counter = <span class="keyword">New</span> StatsCounter()</span><br><span class="line"><span class="keyword">Dim</span> client = <span class="keyword">New</span> NaiveClient(counter)</span><br><span class="line"><span class="comment">' get the method we are going to retry with</span></span><br><span class="line"><span class="keyword">Dim</span> getMyDate <span class="keyword">As</span> Func(<span class="keyword">Of</span> DateTime, <span class="built_in">String</span>) = <span class="keyword">AddressOf</span> client.GetMyDate</span><br><span class="line"></span><br><span class="line"><span class="keyword">Call</span> counter.Stopwatch.Start()</span><br><span class="line"><span class="comment">' intercept it with RetryIfFailed interceptor, which retries once at most</span></span><br><span class="line">getMyDate = getMyDate.RetryIfFailed(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">For</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span> <span class="keyword">To</span> TimesToInvoke</span><br><span class="line">    <span class="keyword">Try</span> </span><br><span class="line">        <span class="comment">' call the intercepted method instead of client.GetMyDate</span></span><br><span class="line">        getMyDate(DateTime.Today.AddDays(i <span class="keyword">Mod</span> <span class="number">30</span>))</span><br><span class="line">        counter.TotalSuccess++</span><br><span class="line">    <span class="keyword">Catch</span> ex <span class="keyword">As</span> Exception </span><br><span class="line">        counter.TotalError+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Try</span></span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Call</span> counter.Stopwatch.<span class="keyword">Stop</span>()</span><br></pre></td></tr></table></figure>
<p>The above program gave a better result. The execution fault rate dropped from the original 325/1000 to 91/1000, simply because we have retried once more.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Execution Time: 59.6016893 seconds</span><br><span class="line">Total Executions: 1302</span><br><span class="line">Execution Sucess: 909</span><br><span class="line">Total Sucess: 909</span><br><span class="line">Execution Fail: 393</span><br><span class="line">Total Fail: 91</span><br></pre></td></tr></table></figure>
<p>If you are not happy with the result, you can tweak the maxRetry parameter in the interceptor to a larger value, for instance 3. Here was the result of “getMyDate.RetryIfFailed(3)” and the fault rate was reduced to around 8/1000.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Execution Time: 65.8972493 seconds</span><br><span class="line">Total Executions: 1421</span><br><span class="line">Execution Sucess: 992</span><br><span class="line">Total Sucess: 992</span><br><span class="line">Execution Fail: 429</span><br><span class="line">Total Fail: 8</span><br></pre></td></tr></table></figure>
<h3 id="Caching-the-Result"><a href="#Caching-the-Result" class="headerlink" title="Caching the Result"></a>Caching the Result</h3><p>In Interceptor in the Wild, Silva also demonstrated caching can be injected to methods via a PoorMansCacheProvider and a CacheInterceptor. The same result can be achieved with the Action Interceptor pattern.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;Extension&gt;</span><br><span class="line"><span class="keyword">Public</span> <span class="function"><span class="keyword">Function</span> <span class="title">GetOrCache</span><span class="params">(Of TArg, TResult, TCache As &#123;Class, IDictionary<span class="params">(Of TArg, TResult)</span>&#125;)</span><span class="params">(func As Func<span class="params">(Of TArg, TResult)</span>, cache As TCache)</span> <span class="title">As</span> <span class="title">Func</span><span class="params">(Of TArg, TResult)</span></span><br><span class="line">    <span class="title">Return</span> <span class="title">_</span></span><br><span class="line">        <span class="title">Function</span><span class="params">(arg)</span></span><br><span class="line">            <span class="title">Dim</span> <span class="title">value</span> <span class="title">As</span> <span class="title">TResult</span></span><br><span class="line"></span><br><span class="line">            <span class="title">If</span> <span class="title">cache</span>.<span class="title">TryGetValue</span><span class="params">(arg, value)</span> <span class="title">Then</span></span><br><span class="line">                <span class="title">Return</span> <span class="title">value</span></span><br><span class="line">            <span class="title">End</span> <span class="title">If</span></span><br><span class="line"></span><br><span class="line">            <span class="title">value</span> = <span class="title">func</span><span class="params">(arg)</span></span><br><span class="line">            <span class="title">cache</span>.<span class="title">Add</span><span class="params">(arg, value)</span></span><br><span class="line"></span><br><span class="line">            <span class="title">Return</span> <span class="title">value</span></span><br><span class="line">        <span class="title">End</span> <span class="title">Function</span></span><br><span class="line"><span class="title">End</span> <span class="title">Function</span></span></span><br></pre></td></tr></table></figure>
<p>We can easily apply it to the calling procedure, after the RetryIfFailed interceptor.</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Dim</span> counter = <span class="keyword">New</span> StatsCounter()</span><br><span class="line"><span class="keyword">Dim</span> client = <span class="keyword">New</span> NaiveClient(counter)</span><br><span class="line"><span class="keyword">Dim</span> cache = <span class="keyword">New</span> Dictionary(<span class="keyword">Of</span> DateTime, <span class="built_in">String</span>)()</span><br><span class="line"><span class="keyword">Dim</span> getMyDate <span class="keyword">As</span> Func(<span class="keyword">Of</span> DateTime, <span class="built_in">String</span>) = <span class="keyword">AddressOf</span> client.GetMyDate</span><br><span class="line"></span><br><span class="line">counter.Stopwatch.Start()</span><br><span class="line">getMyDate = getMyDate.RetryIfFailed(<span class="number">3</span>).GetOrCache(cache)</span><br><span class="line"></span><br><span class="line"><span class="keyword">For</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span> <span class="keyword">To</span> TimesToInvoke - <span class="number">1</span></span><br><span class="line">    <span class="keyword">Try</span></span><br><span class="line">        getMyDate(DateTime.Today.AddDays(i <span class="keyword">Mod</span> <span class="number">30</span>))</span><br><span class="line">        counter.TotalSuccess += <span class="number">1</span></span><br><span class="line">    <span class="keyword">Catch</span> ex <span class="keyword">As</span> Exception</span><br><span class="line">        counter.TotalError += <span class="number">1</span></span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Try</span></span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line"></span><br><span class="line">counter.Stopwatch.[<span class="keyword">Stop</span>]()</span><br><span class="line">counter.PrintStats()</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="string">"Benchmarks: "</span>)</span><br><span class="line">BenchmarkWithActionInterceptor()</span><br><span class="line">BenchmarkWithNInjectInterceptor()</span><br><span class="line">Console.WriteLine(<span class="string">"Press any key to exit"</span>)</span><br><span class="line">Console.ReadKey()</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Note:<br>Although <strong>GetOrCache</strong> is appended after <strong>RetryIfFailed</strong>, since it is actually wrapping around the original function, the cache provided to GetOrCache will be firstly accessed before RetryIfFailed is call.</p>
<p>In short, the later attached methods will be executed earlier.</p>
</blockquote>
<p>The result may look like the following, similar to the final result in Interceptor in the Wild. Since cache was in the play, the execution time was dramatically shortened and the total execution fault rate was dramatically reduced to around zero.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Execution Time: 0.981474 seconds</span><br><span class="line">Total Executions: 36</span><br><span class="line">Execution Sucess: 30</span><br><span class="line">Total Sucess: 1000</span><br><span class="line">Execution Fail: 6</span><br><span class="line">Total Fail: 0</span><br></pre></td></tr></table></figure>
<p>Until now, what we have done is simply adding two extension methods and changing 4 lines of code in the calling procedure.</p>
<ol>
<li>No need to modify the implemetation of the underlying function</li>
<li>No need to NuGet a single bit from the Internet</li>
<li>No need to learn a single new framework</li>
<li>No need to struggle with object instantiation</li>
<li>No need to think about how to alter parameters in interceptors</li>
</ol>
<p>Jobs got done and our days were saved.</p>
<h2 id="Points-of-Interest-Performance"><a href="#Points-of-Interest-Performance" class="headerlink" title="Points of Interest - Performance"></a>Points of Interest - Performance</h2><p>On performance, I enclosed a simple benchmark which compares the speed of Action Inteceptor and NInject (an IoC framework) Interceptor in the code.</p>
<p>The code will call a NopClient which actually does nothing to compare the time spent on different types of interceptions.</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Public</span> <span class="keyword">Class</span> NopClient : <span class="keyword">Implements</span> INaiveClient</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Dim</span> _counter <span class="keyword">As</span> StatsCounter</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Sub</span> <span class="keyword">New</span>(counter <span class="keyword">As</span> StatsCounter)</span><br><span class="line">        _counter = counter</span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Function</span> GetMyDate([<span class="built_in">date</span>] <span class="keyword">As</span> DateTime) <span class="keyword">As</span> <span class="built_in">String</span> <span class="keyword">Implements</span> INaiveClient.GetMyDate</span><br><span class="line">        <span class="keyword">Return</span> <span class="literal">Nothing</span></span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span></span><br></pre></td></tr></table></figure>
<p>The setup code of NInject interceptor looks like the following:</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Public</span> <span class="keyword">Class</span> [<span class="keyword">Module</span>] : <span class="keyword">Inherits</span> NinjectModule</span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Overrides</span> <span class="keyword">Sub</span> Load()</span><br><span class="line">        Kernel.Bind(<span class="keyword">Of</span> StatsCounter)().ToConstant(<span class="keyword">New</span> StatsCounter())</span><br><span class="line">        <span class="keyword">Dim</span> binding = Kernel.Bind(<span class="keyword">Of</span> INaiveClient)().[<span class="keyword">To</span>](<span class="keyword">Of</span> NopClient)()</span><br><span class="line">        binding.Intercept().[<span class="keyword">With</span>](<span class="keyword">Of</span> RetryInterceptor)()</span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span></span><br></pre></td></tr></table></figure>
<p>During practical development, we typically create a client object which is not reusable and call its methods. For instance, we create WebRequest objects to load a web page or DbConnection objects to manage the database. Hence, in performance benchmarks, we must take object initialization into account.</p>
<p>Here are what we are going to time during the benchmark.</p>
<p>The speed of Action Interceptor.</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">For</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span> <span class="keyword">To</span> TimesToInvoke - <span class="number">1</span></span><br><span class="line">    <span class="keyword">Dim</span> nopClient = <span class="keyword">New</span> NopClient(counter)</span><br><span class="line">    <span class="keyword">Dim</span> getMyDate <span class="keyword">As</span> Func(<span class="keyword">Of</span> DateTime, <span class="built_in">String</span>) = <span class="keyword">AddressOf</span> nopClient.GetMyDate</span><br><span class="line"></span><br><span class="line">    getMyDate = getMyDate.RetryIfFailed(<span class="number">3</span>)</span><br><span class="line">    getMyDate(DateTime.MinValue)</span><br><span class="line"><span class="keyword">Next</span></span><br></pre></td></tr></table></figure>
<p>And the speed of a NInject interceptor.</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">For</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span> <span class="keyword">To</span> TimesToInvoke - <span class="number">1</span></span><br><span class="line">    <span class="keyword">Dim</span> client = kernel.[<span class="keyword">Get</span>](<span class="keyword">Of</span> INaiveClient)()</span><br><span class="line">    client.GetMyDate(DateTime.MinValue)</span><br><span class="line"><span class="keyword">Next</span></span><br></pre></td></tr></table></figure>
<p>And here was a result taken from my computer. Action Interceptor was about hundreds of times faster than the NInject Interceptor.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Action interceptor:</span><br><span class="line">Execution Time: 0.1758 milliseconds</span><br><span class="line"></span><br><span class="line">NInject interceptor:</span><br><span class="line">Execution Time: 144.2733 milliseconds</span><br></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The <strong>Action Interceptor</strong> pattern has the following features which are the same as IoC frameworks:</p>
<pre><code>1. It does inject new behaviors to methods we want to change as IoC does (introduced in the Interceptor in the Wild): 
   increasing execution success rates, providing cachability and efficiency, and more.
2. The underlying basic implementation remains unchanged. 
   It does not require you to change a single character in the injected method.
</code></pre><p>And it has the following advantages over IoC frameworks:</p>
<ol>
<li>The construction logic of types is preserved. So you can happily use the old-school new className(parameters) fashion to instantiate objects or apply any factory patterns if needed. The object creation logic therefore remains clean, simple and fully in your control.</li>
<li>It does not force you to use the “injected” version all the time, you can return to use the un-injected original method any time as needed.</li>
<li>Functionalities are clearly, selectively and freely added to existing methods.</li>
<li>No new class or interface is required to be created manually.</li>
<li>New behaviors can be injected to already injected methods at run time, after object initialization.</li>
<li>It is open and fully compatible with IoC frameworks. You can take advantages of their abstraction object factory.</li>
<li>It can be applied to static methods or private methods.</li>
<li>Its performance is much superior than IoC frameworks.</li>
<li>It has no external dependency. No need to reference any third party assemblies.</li>
<li>Plain easy to learn.</li>
<li>Plain easy to debug.</li>
<li>Ready for being refactored.</li>
</ol>
<p>The disadvantages are:</p>
<ol>
<li>It does not serve as an abstract object factory.</li>
<li>It does not wrap properties, except that you wrap the hidden getter or setter method of a property.</li>
<li>It does not inject behaviors to all methods in a type by default. You must manually apply it to methods, one by one.</li>
<li>It is old-fashioned and low-tech. It does not sound COOL in front of your boss at all.</li>
<li>It is up to your decision.</li>
</ol>
<p>IoC frameworks do give us great powers. But we have to face the tradeoffs of added code complexity and performance loss. When I saw people asking questions about IoC frameworks here and there, which were originally simple without IoC, I wondered whether they were using the right tool.</p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/06/10/3d_rotation/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          3D Rotation
        
      </div>
    </a>
  
  
    <a href="/2016/06/08/yaml/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">YAML Syntax</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>








<section id="comments">
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'xieguigang'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>

</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 しゃけい よしつな
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>