<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>VB.NET 线程池 | 拾荒者</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="水是生命之源，计算机资源也一样。

每一线程尤如一滴水，你花一滴，我花一滴，你还一滴，我还一滴，就象游兵散将一样，线程越多，越复杂混乱。而每一个线程创建需要开销，活动的线程也需要开销。过多的线程导致系统内存占用过度或系统资源不足。为了解决线程生命周期开销问题和资源不足问题，创建线程池，让每滴水（线程）纳入统一管理。特别是那些生存期比较短暂的线程。使用线程池执行任务比每次完成一个任务时都创建一个全">
<meta property="og:type" content="article">
<meta property="og:title" content="VB.NET 线程池">
<meta property="og:url" content="http://blog.xieguigang.me/2016/08/13/vbnet_threadpool/index.html">
<meta property="og:site_name" content="拾荒者">
<meta property="og:description" content="水是生命之源，计算机资源也一样。

每一线程尤如一滴水，你花一滴，我花一滴，你还一滴，我还一滴，就象游兵散将一样，线程越多，越复杂混乱。而每一个线程创建需要开销，活动的线程也需要开销。过多的线程导致系统内存占用过度或系统资源不足。为了解决线程生命周期开销问题和资源不足问题，创建线程池，让每滴水（线程）纳入统一管理。特别是那些生存期比较短暂的线程。使用线程池执行任务比每次完成一个任务时都创建一个全">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616100734269.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616100847350.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616100847350.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616101208602.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616101736120.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616101828824.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616102020879.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616102132021.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616102228241.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616102959250.png">
<meta property="og:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/qrcode/vbnet_threadpool.png">
<meta property="og:updated_time" content="2016-08-14T08:59:20.590Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="VB.NET 线程池">
<meta name="twitter:description" content="水是生命之源，计算机资源也一样。

每一线程尤如一滴水，你花一滴，我花一滴，你还一滴，我还一滴，就象游兵散将一样，线程越多，越复杂混乱。而每一个线程创建需要开销，活动的线程也需要开销。过多的线程导致系统内存占用过度或系统资源不足。为了解决线程生命周期开销问题和资源不足问题，创建线程池，让每滴水（线程）纳入统一管理。特别是那些生存期比较短暂的线程。使用线程池执行任务比每次完成一个任务时都创建一个全">
<meta name="twitter:image" content="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616100734269.png">
    

    
        <link rel="alternate" href="/" title="拾荒者" type="application/atom+xml" />
    

    
        <link rel="icon" href="http://xieguigang.me/favicon.ico" />
    

    <link rel="stylesheet" href="/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/vendor/open-sans/styles.css">
    <link rel="stylesheet" href="/vendor/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/vendor/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/vendor/fancybox/jquery.fancybox.css">
    
    
    
    

</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">拾荒者</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/nuget">nuget</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/my/WeChatImage636059681622385094.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/nuget">nuget</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/my/WeChatImage636059681622385094.jpg" />
            <h2 id="name">xieguigang</h2>
            <h3 id="title">GCModeller chief developer</h3>
            <span id="location"><i class="fa fa-map-marker"></i>GuiLin, China (中國 · 桂林)</span>
            <a id="follow" target="_blank" href="https://github.com/xieguigang">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                40
                <span>文章</span>
            </div>
            <div class="article-info-block">
                83
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="http://github.com/xieguigang" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="/" target="_blank" title="rss" class=tooltip>
                            <i class="fa fa-rss"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-vbnet_threadpool" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            VB.NET 线程池
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/2016/08/13/vbnet_threadpool/">
            <time datetime="2016-08-12T16:00:00.000Z" itemprop="datePublished">2016-08-13</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/threading/">threading</a>, <a class="tag-link" href="/tags/threadpool/">threadpool</a>, <a class="tag-link" href="/tags/vb-net/">vb.net</a>, <a class="tag-link" href="/tags/web-server/">web server</a>, <a class="tag-link" href="/tags/线程池/">线程池</a>
    </div>

                    </div>
                
            </header>
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <blockquote>
<p>水是生命之源，计算机资源也一样。</p>
</blockquote>
<p>每一线程尤如一滴水，你花一滴，我花一滴，你还一滴，我还一滴，就象游兵散将一样，线程越多，越复杂混乱。<strong>而每一个线程创建需要开销，活动的线程也需要开销。过多的线程导致系统内存占用过度或系统资源不足。</strong>为了解决线程生命周期开销问题和资源不足问题，创建线程池，让每滴水（线程）纳入统一管理。特别是那些生存期比较短暂的线程。使用线程池执行任务比每次完成一个任务时都创建一个全新的线程，随后又删除掉的做法更有效率。</p>
<h2 id="一、线程池管理"><a href="#一、线程池管理" class="headerlink" title="一、线程池管理"></a>一、线程池管理</h2><p>线程池管埋是指在多线程应用程序的初始化过程屮创建线程的一个集合，当需要线程时，为新任务重用这些线程，而不是创建新的线程的过程。这个过程中创建的线程数量通常部是固定的。然而，增加可用的线程数量也是可以的。池中的每个线程都被分派一个任务，当任务完成时，线程就返回线程池中等待下一次分派。</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616100734269.png" alt="进程池模型"></p>
<a id="more"></a>
<h3 id="1-什么时候需要用线程池"><a href="#1-什么时候需要用线程池" class="headerlink" title="1. 什么时候需要用线程池"></a>1. 什么时候需要用线程池</h3><p>线程池在多线程应用程序中是必需的，原因如下：</p>
<ol>
<li>线程池有效改善了应用程序的响应时间，因为线程池中的线程是现成的，就处于等待任务分派的状态中，系统无需再从头创建线程。</li>
<li>在线程池方式下，CLR节省了为每个生存期短暂的任务创建一个全新线程，并在其结束时回收其资源的开销。</li>
<li>线程池根据系统当前正在运行的进程情况优化线程时间片。</li>
<li>线程池允许我们在不逐一设置线程的属性的情况下，启动多个线程。</li>
<li>线程池允许我们将状态信息作为一个对象传递给当前正在执行任务的过程参数。</li>
<li>线程池可以将处理客户请求的线程数量固定为某一个最大值。</li>
</ol>
<h3 id="2-线程池的概念"><a href="#2-线程池的概念" class="headerlink" title="2. 线程池的概念"></a>2. 线程池的概念</h3><p>影响多线程应用程序的响应性的一个主要原因就是为每个任务创建线程的时间开销。<br>例如，Web服务器是响应10个客户的访问，以前的做法是：若服务器采用为每个客户创建一个线程的策略，则需创建10个新线程。服务器将承担线程的创建、在整个生存期内管理这些线程的开销。在某个时刻，线程可能会耗尽整个系统的资源。替代的方法：若服务器使用线程池来响应客户请求，每当客户发出请求时，系统就无需再为创建线程耗费时间。这就是线程池管理方式的重要概念。<br>Windows操作系统为响应客户请求维护一个线程池。当我们的应用程序请求一个新的线程时，Windows就试图从池中取出一个，如果线程池是空的，那就创建一个新的供我们使用。Windows将动态处理线程池的大小以加快应用程序的响应时间。</p>
<p>影响多线程应用程序线程设计的因素有:<strong>应用程序的响应性、线程管理资源的分配、资源共享、线程同步</strong>。</p>
<h2 id="二、CLR与线程池"><a href="#二、CLR与线程池" class="headerlink" title="二、CLR与线程池"></a>二、CLR与线程池</h2><p>CLR是专门用于创建托管代码环境，为在.NET平台上运行的应用程序提供各种服务的，例如编译、垃圾收集、内存管理，还有线程池。</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616100847350.png" alt="CLR"></p>
<p>确实，在定义宿主应用程序使用的线程的进程方面，Win32和.NET Framework有着显著的差别。<br>在传统的多线程Win32应用程序中，每个进程都是由线程集合组成的。每个线程又由线程本地存储(Thread Local Storage，TLS)、调用堆栈组成，用于在单处理器系统中提供时间片。单处理器系统根据线程的优先级为每个线程分配时间片。当某个特定线程的时间片消耗完时，它就会处于挂起状态，其他线程就将开始执行其任务。<br>在.NET Framework中，每个进程都可分成多个应用程序域，它是用于宿主线程以及TLS和调用堆栈的。值得关注的是，进程间的通信是通过.NETFramework中的一个称为远程处理的技术来进行处理的。</p>
<h3 id="1．CLR管理线程池"><a href="#1．CLR管理线程池" class="headerlink" title="1．CLR管理线程池"></a>1．CLR管理线程池</h3><p>CLR构成了.NET Framework的灵魂和核心，为托管应用程序提供多个服务(线程池管理就是其中之一)。对于线程池中排在队列中的每个任务(任务项)，CLR从线程池中指派一个线程(工作者线程)，然后在任务结束时将线程释放回池中。</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616100847350.png" alt="CLR"></p>
<p>线程池总是通过CLR使用多线程单元模式，借助抢先式多任务管理使用高性能的队列和调度程序来实现的。它是CPU时间被分成多个时间片的一个过程。在每个时间片中，都有个特定的线程在执行，而其他线程则处于等待状态。一旦这个时间片用完之后，系统就根据剩余线程的最高优先级决定由哪个线程使用CPU。客户请求排在任务队列中，队列中的毎个任务都将被分配给线程池中第一个可用的线程。<br>一旦线程完成了分配给它的任务，它就返回到线程池中等待CLR的下一次分配。<br>线程池的大小可以是固定不变的，也可以是动态变化的。在前面的示例中，线程的数量在线程池的生存期间不发生变化。通常情况下，这种类型的线程池用于我们确切知道应用程序可用资源的数量的情况，这样固定数目的线程就可以在线程池初始化过程中创建完成。<br>面这种情况正好适用于这种类型：我们为企业内部网开发解决方案或者在可以严格定义目标平台的系统需求的应用程序中，大小动态可变的线程池适用于不知道可用资源数量的情况，因为在Web服务器的情况下，我们不知道将要同时处理多少客户请求。</p>
<h3 id="2-避免使用线程池的情况"><a href="#2-避免使用线程池的情况" class="headerlink" title="2. 避免使用线程池的情况"></a>2. 避免使用线程池的情况</h3><p>尽管线程池在我们构建多线程应用程序时给我们带來了大量的好处,但是，下面情况应避免使用线程池：</p>
<ol>
<li>CLR将线程池中的线程分配给任务，并在任务完成时将线程释放间池中。如果任务已经被添加到队列中，此时就没有直接的方法可以终止任务。</li>
<li>线程池管理对于任务生存期较短的情况非常有效，例如Web服务器响应客户对某个特定文件的请求。线程池不适用又大又长的任务。</li>
<li>线程池管理是一种以成本效率方式使用线程的技术，此处成本效率根据数量和启动开销来确定，决定使用池中线程的时候要十分小心。线程池的大小应该固定不变。</li>
<li>线程池中的所有线程都是处于多线程单元之中。如果我们想把线程放置到单线程单元中，那么线程池就没有用了。</li>
<li>如果我们想标识线程并执行各种操作，例如启动线程、挂起和中止等，那么线程池不能完成这样的工作。</li>
<li>同样，我们不可能对使用线程池的任务设置优先级。</li>
<li>对任意给定的进程，只能有一个线程池与其相关联。</li>
<li>如果分配给线程池中的一个线程的任务被锁定，那么这个线程将不会再释放回池中。这种情况可以通过使用有效的编程技巧加以避免。</li>
</ol>
<h3 id="3-线程池的大小"><a href="#3-线程池的大小" class="headerlink" title="3. 线程池的大小"></a>3. 线程池的大小</h3><p>线程池中可以排队等待的任务数量取决于机器的内存数量。同样，在进程中可以激活的线程数量取决于机器中的CPU个数。<br>正如我们己经知道的，这是因为每个处理器在同一时间只能执行一个线程，默认情况下，处在多线程单元中的线程池的每个线程都将使用默认的任务，运行库将采用默认的优先级。此处使用的单词“默认”显得似乎有些不太明确，但这不会产生任何问题。每个系统都有的默认优先级设置。<br>在任意时刻，如果某个线程处于空闲状态，那么线程池就会引导工作者线程使所有的处理器保持繁忙。如果线程池中的所有线程都处于繁忙状态，并且队列中有未处理的任务，那么线程池将产生一个新的线程来完成待处理的工作。但是，产生的线程数量不能超过指定的最大值。</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616101208602.png" alt="CLR线程池"></p>
<p>默认情况下，每个进程可以产生25个线程池线程。然而，这个数量可以通过编辑mscoree.h文件中定义的CorSetMaxThreads成员加以改变，万一要是有额外的线程请求的话，那么这个请求将加入到队列中，直到某些线程完成了分配给它的任务返回到线程池中为止。<br>.NET Framework对异步调用、建立套接字连接和注册过的等待操作等使用线程池功能。</p>
<h2 id="三、ThreadPool-类"><a href="#三、ThreadPool-类" class="headerlink" title="三、ThreadPool 类"></a>三、ThreadPool 类</h2><p>为了在应用程序中使用线程池，.NET Framework在System.Threading命名空间中提供了 ThreadPool类。ThreadPool类提供的线程池可以用来解决以下问题: 处理任务项、处埋异步I/O调用、处理计时器、代表其他线程等待。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BindHandle()</code></td>
<td>将操作系统句柄绑定到<code>ThreadPool</code></td>
</tr>
<tr>
<td><code>GetAvailableThreads()</code></td>
<td>可以添加到任务队列中的任务项的数量</td>
</tr>
<tr>
<td><code>GetMaxThreads()</code></td>
<td>线程池可以同时排队的线程数</td>
</tr>
<tr>
<td><code>QueueUserWorkItem()</code></td>
<td>将一个任务项排列到时线程池中</td>
</tr>
<tr>
<td><code>RegisterWaitForSingleObject</code></td>
<td>注册一个委托，它等待一个<code>WaitHandle</code></td>
</tr>
<tr>
<td><code>UnsafeQueueUserWorkItem()</code></td>
<td>将指定的委托排队到线程池，但不会将调用堆栈传播到辅助线程</td>
</tr>
<tr>
<td><code>UnsafeRegisterWaitForSingleObject()</code></td>
<td>注册一个等待<code>WaitHandle</code>的委托，并指定超时值。此方法不将调用堆栈传播到辅助线程</td>
</tr>
</tbody>
</table>
<h5 id="BindHandle-SafeHandle"><a href="#BindHandle-SafeHandle" class="headerlink" title="BindHandle(SafeHandle)"></a>BindHandle(SafeHandle)</h5><p>将操作系统句柄绑定到<code>ThreadPool</code>。返回值True绑定成功，False绑定失败。</p>
<ul>
<li><code>osHandle</code> 保存操作系统句柄的<code>SafeHandle</code>。在非托管端必须为重叠 I/O 打开该句柄。</li>
</ul>
<h5 id="GetAvailableThreads-workerThreads-completionPortThreads"><a href="#GetAvailableThreads-workerThreads-completionPortThreads" class="headerlink" title="GetAvailableThreads(workerThreads, completionPortThreads)"></a>GetAvailableThreads(workerThreads, completionPortThreads)</h5><p>检索由<code>GetMaxThreads</code>方法返回的最大线程池线程数和当前活动线程数之间的差值。</p>
<ul>
<li><code>WorkerThreads</code>          线程池中工作者线程的最大数目。</li>
<li><code>completionPortThreads</code>  线程池中异步 I/O 线程的最大数目。</li>
</ul>
<h5 id="GetMaxThreads-workerThreads-completionPortThreads"><a href="#GetMaxThreads-workerThreads-completionPortThreads" class="headerlink" title="GetMaxThreads(workerThreads, completionPortThreads)"></a>GetMaxThreads(workerThreads, completionPortThreads)</h5><p>检索可以同时处于活动状态的线程池请求的数目。所有大于此数目的请求将保持排队状态，直到线程池线程变为可用。</p>
<ul>
<li><code>workerThreads</code>           线程池中工作者线程的最大数目。</li>
<li><code>completionPortThreads</code>   线程池中异步 I/O 线程的最大数目。</li>
</ul>
<h5 id="QueueUserWorkItem-WaitCallback"><a href="#QueueUserWorkItem-WaitCallback" class="headerlink" title="QueueUserWorkItem(WaitCallback)"></a>QueueUserWorkItem(WaitCallback)</h5><h5 id="ThreadPool-QueueUserWorkItem-WaitCallback-state"><a href="#ThreadPool-QueueUserWorkItem-WaitCallback-state" class="headerlink" title="ThreadPool.QueueUserWorkItem(WaitCallback, state)"></a>ThreadPool.QueueUserWorkItem(WaitCallback, state)</h5><p>将一个任务项排列到线程池中。返回值True执行成功，False执行失败。</p>
<ul>
<li><code>callBack</code>                一个<code>WaitCallback</code>(委托)，表示要执行的方法。</li>
<li><code>State</code>                   传递给委托的对象。</li>
</ul>
<h5 id="RegisterWaitForSingleObject-WaitHandle-WaitOrTimerCallback-state-Int32-Boolean"><a href="#RegisterWaitForSingleObject-WaitHandle-WaitOrTimerCallback-state-Int32-Boolean" class="headerlink" title="RegisterWaitForSingleObject(WaitHandle, WaitOrTimerCallback,state, Int32, Boolean)"></a>RegisterWaitForSingleObject(WaitHandle, WaitOrTimerCallback,state, Int32, Boolean)</h5><p>注册一个等待 WaitHandle 的委托，并指定超时值（毫秒）。</p>
<ul>
<li><code>waitObject</code>                   要注册的<code>WaitHandle</code>。使用<code>WaitHandle</code>而非<code>Mutex</code>。</li>
<li><code>callBack</code>                     向<code>waitObject</code>参数发出信号时调用的<code>WaitOrTimerCallback</code>委托。</li>
<li><code>State</code>                        传递给委托的对象。</li>
<li><code>millisecondsTimeOutInterval</code>  以毫秒为单位的超时。为0立即返回。为-1永远不过期。</li>
<li><code>executeOnlyOnce</code>              为true表示委托后线程将不再在<code>waitObject</code>参数上等待；为false表示每次完成等待操作后都重置计时器，直到注销等待。</li>
</ul>
<h5 id="UnsafeRegisterWaitForSingleObject-WaitHandle-WaitOrTimerCallback-Object-Int32-Boolean"><a href="#UnsafeRegisterWaitForSingleObject-WaitHandle-WaitOrTimerCallback-Object-Int32-Boolean" class="headerlink" title="UnsafeRegisterWaitForSingleObject(WaitHandle,WaitOrTimerCallback,Object,Int32,Boolean)"></a>UnsafeRegisterWaitForSingleObject(WaitHandle,WaitOrTimerCallback,Object,Int32,Boolean)</h5><p>注册一个等待 WaitHandle 的委托，并使用超时时间（毫秒）。此方法不将调用堆栈传播到辅助线程。</p>
<ul>
<li><code>waitObject</code>                     要注册的<code>WaitHandle</code>。使用<code>WaitHandle</code>而非<code>Mutex</code>。</li>
<li><code>callBack</code>                       向<code>waitObject</code>参数发出信号时调用的委托。</li>
<li><code>State</code>                          传递给委托的对象。</li>
<li><code>millisecondsTimeOutInterval</code>    以毫秒为单位的超时。为0立即返回。为-1永远不过期。</li>
<li><code>executeOnlyOnce</code>                为true表示委托后线程将不再在<code>waitObject</code>参数上等待；为false表示每次完成等待操作后都重置计时器，直到注销等待。</li>
</ul>
<h2 id="四、VB-NET中线程池的编程"><a href="#四、VB-NET中线程池的编程" class="headerlink" title="四、VB.NET中线程池的编程"></a>四、VB.NET中线程池的编程</h2><p>ThreadPool类的3个规则：</p>
<ol>
<li>每个<code>ThreadPool</code>对象只能有一个工作者线程；</li>
<li>每个进程只能有一个<code>ThreadPool</code>对象；</li>
<li>第一次创建<code>ThreadPool</code>对象是当我们调用<code>ThreadPool.QueueUserWorkItem()</code>方法，或者是通过计时器或已注册等待的操作调用回调方法时发生的。</li>
</ol>
<p><code>ThreadPool</code>类的一个普通用法就是不用设置每个线程的属性而启动多个独立的任务。例：微软例子：</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Imports</span> System.Threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">Public</span> <span class="keyword">Class</span> Example</span><br><span class="line"></span><br><span class="line">    &lt;MTAThread&gt; <span class="keyword">Public</span> <span class="keyword">Shared</span> <span class="keyword">Sub</span> Main()</span><br><span class="line">        ThreadPool.QueueUserWorkItem(<span class="keyword">New</span> WaitCallback(<span class="keyword">AddressOf</span> ThreadProc)) <span class="comment">' 委托方法入队</span></span><br><span class="line">        <span class="comment">'ThreadPool.QueueUserWorkItem(AddressOf ThreadProc)                  ‘ 等同上面语句</span></span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">"Main thread does some wor, then sleeps."</span>)</span><br><span class="line">        Thread.Sleep(<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">"Main thread exits."</span>)</span><br><span class="line">        Console.ReadLine()</span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Shared</span> <span class="keyword">Sub</span> ThreadProc(stateInfo <span class="keyword">As</span> <span class="built_in">Object</span>) <span class="comment">'无状态传来，为空</span></span><br><span class="line">        Console.WriteLine(<span class="string">"Hello from the thread pool."</span>)</span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span></span><br></pre></td></tr></table></figure>
<p>说明：创建线程池后，两线程入队，Main线程活动时，ThreadProc只能等待；Main线程Sleep时，ThreadProc激活，其执行完后，Main线程又激活。</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616101736120.png" alt=""></p>
<p>例：理解线程池中各线程执行次序。</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Imports</span> System.Threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">Friend</span> <span class="keyword">Class</span> ObjState</span><br><span class="line">    <span class="keyword">Friend</span> inarg1 <span class="keyword">As</span> <span class="built_in">String</span></span><br><span class="line">    <span class="keyword">Friend</span> inarg2 <span class="keyword">As</span> <span class="built_in">String</span></span><br><span class="line">    <span class="keyword">Friend</span> outval <span class="keyword">As</span> <span class="built_in">String</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Module</span> ThreadAppModule</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Sub</span> Taskl(<span class="keyword">ByVal</span> StateObj <span class="keyword">As</span> <span class="built_in">Object</span>)     <span class="comment">'任务1</span></span><br><span class="line">        <span class="keyword">Dim</span> StObj <span class="keyword">As</span> ObjState = <span class="built_in">CType</span>(StateObj, ObjState) <span class="comment">'传来的状态转类型</span></span><br><span class="line">        Console.WriteLine(<span class="string">"Input Argument 1 in task 1:"</span> &amp; StObj.inarg1)  </span><br><span class="line">        Console.WriteLine(<span class="string">"Input Argument 2 in task 1: "</span> &amp; StObj.inarg2)  </span><br><span class="line">        StObj.outval = <span class="string">"From Task1 "</span> &amp; StObj.inarg1 &amp; <span class="string">" "</span> &amp; StObj.inarg2 <span class="comment">'此对象还可作返回值  </span></span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Sub</span> Task2(<span class="keyword">ByVal</span> StateObj <span class="keyword">As</span> <span class="built_in">Object</span>)     <span class="comment">'任务2  </span></span><br><span class="line">        <span class="keyword">Dim</span> StObj <span class="keyword">As</span> ObjState = <span class="built_in">CType</span>(StateObj, ObjState)  </span><br><span class="line">        Console.WriteLine(<span class="string">"Input Argument 1 in task 2:"</span> &amp; StObj.inarg1)  </span><br><span class="line">        Console.WriteLine(<span class="string">"Input Argument 2 in task 2:"</span> &amp; StObj.inarg2)  </span><br><span class="line">        StObj.outval = <span class="string">"From Task2 "</span> &amp; StObj.inarg1 &amp; <span class="string">" "</span> &amp; StObj.inarg2  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Sub</span> Main()</span><br><span class="line">        <span class="keyword">Dim</span> StObj1 <span class="keyword">As</span> <span class="keyword">New</span> ObjState()  </span><br><span class="line">        <span class="keyword">Dim</span> StObj2 <span class="keyword">As</span> <span class="keyword">New</span> ObjState()  </span><br><span class="line">        StObj1.inarg1 = <span class="string">"String Param1 of task 1"</span> <span class="comment">'分别设置两对象值  </span></span><br><span class="line">        StObj1.inarg2 = <span class="string">"String Param2 of task 1"</span>  </span><br><span class="line">        StObj2.inarg1 = <span class="string">"String Param1 of task 2"</span>  </span><br><span class="line">        StObj2.inarg2 = <span class="string">"String Param2 of task 2"</span>  </span><br><span class="line">        <span class="comment">'进程中只有一个Threadpool，且成员多为共享，故不必单独为其实例化对象，直接用类。  </span></span><br><span class="line">        ThreadPool.QueueUserWorkItem(<span class="keyword">New</span> Threading.WaitCallback(<span class="keyword">AddressOf</span> Taskl), StObj1)  </span><br><span class="line">        ThreadPool.QueueUserWorkItem(<span class="keyword">New</span> Threading.WaitCallback(<span class="keyword">AddressOf</span> Task2), StObj2)  </span><br><span class="line">        Console.Read()  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Module</span></span><br></pre></td></tr></table></figure>
<p>说明：任务1与任务2通过线程池逐个激活（反正不让任务线程空闲）,传递给委托方法的对象都被转了定义的ObjState类型。</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616101828824.png" alt=""></p>
<p>例：理解定时触发器与开关门的关系</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Imports</span> System.Threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">Public</span> <span class="keyword">Class</span> vbThreadPool</span><br><span class="line">    <span class="keyword">Private</span> <span class="keyword">Shared</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Shared</span> <span class="keyword">Sub</span> main()</span><br><span class="line">        <span class="keyword">Dim</span> arev <span class="keyword">As</span> <span class="keyword">New</span> AutoResetEvent(<span class="literal">False</span>)      <span class="comment">'1、自动同步  </span></span><br><span class="line">        <span class="comment">'Dim arev As New ManualResetEvent(False)   ‘2、手动同步  </span></span><br><span class="line">        <span class="comment">'注册(添加）一个定时器(定时触发委托项),第一参数为开关量以确定开或关，此处False为关，受阻。  </span></span><br><span class="line">        ThreadPool.RegisterWaitForSingleObject(arev, <span class="keyword">AddressOf</span> workitem, <span class="literal">Nothing</span>, <span class="number">1000</span>, <span class="literal">False</span>) <span class="comment">'3、定时触发器  </span></span><br><span class="line">        arev.<span class="keyword">Set</span>()   <span class="comment">'4、开关量打开(True),定时器启动（如Timer一样，每1秒调用委托方法)  </span></span><br><span class="line">        Console.Read()  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Shared</span> <span class="keyword">Sub</span> workitem(<span class="keyword">ByVal</span> obj <span class="keyword">As</span> <span class="built_in">Object</span>, <span class="keyword">ByVal</span> signaled <span class="keyword">As</span> <span class="built_in">Boolean</span>)</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        Console.WriteLine(<span class="string">"Thread Pool Work Item Ivoked:"</span> &amp; i.ToString)</span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span></span><br></pre></td></tr></table></figure>
<p>说明：本例代码简单，理解较难。</p>
<h4 id="1-理解线程池的RegisterWaitForSingleObject。"><a href="#1-理解线程池的RegisterWaitForSingleObject。" class="headerlink" title="1. 理解线程池的RegisterWaitForSingleObject。"></a>1. 理解线程池的RegisterWaitForSingleObject。</h4><p>它是一个定时触发器，类似Timer控件一样，即每隔一段时间触发委托方法。<br>第一参数WaitHandle是一个关开量（开True,关False）,它可以是手动同步ManualResetEvent或自动同步AutoResetEvent,它类似一个大门；第二参数委托方法，类似大门内关着的一匹马；第三参数state状态对象，类似给马的货物或装饰（当然也可以没有Nothing）；第四参数间隔时间,类似开大门时需要间隔多久（每开一次门，就跑出一匹马，方法就执行起来了），第五参数是否只开一次门（方法也就只能执行一次，如右图）。为真，总共只执行一次；为假，不止执行一次。<br>因此，上面3处代码可以解释为：每隔1秒触发打开大门，马儿就跑出来，马儿无货物托运，并且总共大门不止开一次。即一直间隔1秒地去开门。</p>
<h4 id="2-理解Set"><a href="#2-理解Set" class="headerlink" title="2. 理解Set"></a>2. 理解Set</h4><p>Set的目的，在AutoResentEvent自动同步中，直接打开门（True），于是下面左图或右图第一语句都是没有等1秒，就执行了。因为Set是另一个人来打开门（不是定时触发器来打开门），也即打开门有两种方式。既然门开了，马儿就直接跑出来了，还管什么定时触发器的1秒间隔？所以第一句都没有等待1秒，就直接显示出来了。<br>但后面语句(红箭头)都是等待了1秒才显示。这里又涉及到手动同步（ManualResetEvent）或自动同步（AutoResetEvent）的区别：<br>若是用的1处的自动同步（AutoResetEvent）,它就类似自动门一样，打开(Set为真)后，跑出一匹马，然后大门会自动关上(为假)，所以这里定时触发器的间隔时间就体现出来了：每隔一秒去开大门，跑出马后会自动关上大门，所以后面每隔一秒会显示信息。<br>若是用的2处的手动同步（ManualResetEvent），情况就不一样的，大门不是自动大门，打开(Set其为True)后不会自动关门(False)。如果用了4处的开大门，大门不会再关闭，大大地敞开，于是马儿一匹接一匹的向外跑，于是信息就无间隔的连续一直显示下去。定时触发器中的时间间隔就不会起作用。<br>本来定时触发器也有自动关门的作用，因为没有开也就没有与之对应的关（因为开是别人做的）,所以它也只有干瞪眼看着一匹接一匹的马儿跑。如果我们注释掉1处使用2处语句，同时注释掉4处，就会发现：第一句也会间隔1秒（因为没人去开门，所以定时触发器来开门），然后，后面也是每隔一秒显示（因为定时触发器自已开门，也会自动去关门）。</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616102020879.png" alt=""></p>
<h2 id="五、在-NET中的可伸缩性"><a href="#五、在-NET中的可伸缩性" class="headerlink" title="五、在.NET中的可伸缩性"></a>五、在.NET中的可伸缩性</h2><p>Windows 操作系统管理着如何将线程分配给处理器，同时，触发任何进程会自动启动一个线程。.NET Framework对处理器分配不提供细粒度的控制，它宁愿让操作系统控制调度，因为与CLR相比，处理器提供更多的载入信息。然而，它还是对整个进程运行于哪个处理器提供了一些控制措施。但是这适用于进程中的所有线程，选择哪些处理器来处理超出了我们的话题。<br>如果只有一个线程（即主线程），那么线程中的每个任务都将运打在相同的处理器上。然而，如果创建一个新的线程，那么操作系统将安排线程将在哪个处理器上执行。系统在作出这个判断时会消耗一些处理器资源，所以对于那些小的任务而言，这种消耗通常不值得，因为执行这些任务的时间几乎和判断由哪个处理器来执行线程的时间一样。<br>然而，随着Windows版本的延续，这种分配占用的时间越来越少，同时对于除最细微的任务之外的事情而言,当使用线程时，您将发现通过创建新线程来执行任务将提高系统性能。这也只有在对称多处现器(symmetric multi-processor, SMP)系统中您才能看到线程的真正优点，因为所有的处理器都会被充分用于分配承担应用程序的负荷。</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616102132021.png" alt=""></p>
<h5 id="通用线程池管理器类的设计"><a href="#通用线程池管理器类的设计" class="headerlink" title="通用线程池管理器类的设计"></a>通用线程池管理器类的设计</h5><p>以前创建线程的方法过于松散自由，现在线程池又过于僵硬呆板。下面创建一个线程池管理类，它维护指定数量线程的线程池，这些线程用于请求的应用程序。这样既可以在代码中更加容易控制这些线程，同时在实例化线程对象时更快地执行线程。简单地说，就是综合两者的优点。<br>代码较长，逻辑图有点类似下面（引用别人的图），只是少了一部分超时的判断。</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616102228241.png" alt=""></p>
<p>提示：右击关键词，可以选择<code>转到定义</code>（迅速到定义处）或<code>转到实现</code>（迅速到实现处）,工具栏左端面有一个<code>后退</code>，可迅速回到前一个代码定位处。</p>
<p>首先添加一个新的类（管理器类）:</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Imports</span> System.Threading</span><br><span class="line"><span class="keyword">Imports</span> System.<span class="keyword">Text</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Namespace</span> GenThreadPool <span class="comment">'通用线程池管理</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Interface</span> IThreadPool       <span class="comment">'ThreadPool接口，用于GenThreadPoolImpl类  </span></span><br><span class="line">        <span class="keyword">Sub</span> AddJob(jobToRun <span class="keyword">As</span> Thread) <span class="comment">'添加作业  </span></span><br><span class="line">        <span class="keyword">Function</span> GetStats() <span class="keyword">As</span> Stats   <span class="comment">'获取状态  </span></span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Interface</span></span><br><span class="line"><span class="keyword">End</span> Namesapce</span><br></pre></td></tr></table></figure>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Public</span> <span class="keyword">Class</span> GenThreadPoolImpl  </span><br><span class="line">    <span class="keyword">Implements</span> IThreadPool</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Private</span> m_maxThreads <span class="keyword">As</span> <span class="built_in">Integer</span>         <span class="comment">'最多线程  </span></span><br><span class="line">    <span class="keyword">Private</span> m_minThreads <span class="keyword">As</span> <span class="built_in">Integer</span>         <span class="comment">'最少线程  </span></span><br><span class="line">    <span class="keyword">Private</span> m_maxIdleTime <span class="keyword">As</span> <span class="built_in">Integer</span>        <span class="comment">'最长空闲时间（超时删除对应线程)  </span></span><br><span class="line">    <span class="keyword">Private</span> <span class="keyword">Shared</span> m_debug <span class="keyword">As</span> <span class="built_in">Boolean</span>       <span class="comment">'是否调试  </span></span><br><span class="line">    <span class="keyword">Private</span> m_pendingJobs <span class="keyword">As</span> ArrayList      <span class="comment">'等待的作业量（数组形式，以便列队进入线程池)  </span></span><br><span class="line">    <span class="keyword">Private</span> m_availableThreads <span class="keyword">As</span> ArrayList <span class="comment">'可用线程数  </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Property</span> PendingJobs() <span class="keyword">As</span> ArrayList  </span><br><span class="line">        <span class="keyword">Get</span>  </span><br><span class="line">            <span class="keyword">Return</span> m_pendingJobs  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Get</span>  </span><br><span class="line">        <span class="keyword">Set</span>  </span><br><span class="line">            m_pendingJobs = Value  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Set</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Property</span>  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Property</span> AvailableThreads() <span class="keyword">As</span> ArrayList  </span><br><span class="line">        <span class="keyword">Get</span>  </span><br><span class="line">            <span class="keyword">Return</span> m_availableThreads  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Get</span>  </span><br><span class="line">        <span class="keyword">Set</span>  </span><br><span class="line">            m_availableThreads = Value  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Set</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Property</span>  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Property</span> Debug() <span class="keyword">As</span> <span class="built_in">Boolean</span>  </span><br><span class="line">        <span class="keyword">Get</span>  </span><br><span class="line">            <span class="keyword">Return</span> m_debug  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Get</span>  </span><br><span class="line">        <span class="keyword">Set</span>  </span><br><span class="line">            m_debug = Value  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Set</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Property</span>  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Property</span> MaxIdleTime() <span class="keyword">As</span> <span class="built_in">Integer</span>  </span><br><span class="line">        <span class="keyword">Get</span>  </span><br><span class="line">            <span class="keyword">Return</span> m_maxIdleTime  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Get</span>  </span><br><span class="line">        <span class="keyword">Set</span>  </span><br><span class="line">            m_maxIdleTime = Value  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Set</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Property</span>  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Property</span> MaxThreads() <span class="keyword">As</span> <span class="built_in">Integer</span>  </span><br><span class="line">        <span class="keyword">Get</span>  </span><br><span class="line">            <span class="keyword">Return</span> m_maxThreads  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Get</span>  </span><br><span class="line">        <span class="keyword">Set</span>  </span><br><span class="line">            m_maxThreads = Value  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Set</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Property</span>  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Property</span> MinThreads() <span class="keyword">As</span> <span class="built_in">Integer</span>  </span><br><span class="line">        <span class="keyword">Get</span>  </span><br><span class="line">            <span class="keyword">Return</span> m_minThreads  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Get</span>  </span><br><span class="line">        <span class="keyword">Set</span>  </span><br><span class="line">            m_minThreads = Value  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Set</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Property</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Sub</span> <span class="keyword">New</span>()       <span class="comment">'默认构造。只允许1个线程在池中，0.3秒后销毁  </span></span><br><span class="line">        m_maxThreads = <span class="number">1</span>  </span><br><span class="line">        m_minThreads = <span class="number">0</span>  </span><br><span class="line">        m_maxIdleTime = <span class="number">300</span>  </span><br><span class="line">        m_pendingJobs = ArrayList.Synchronized(<span class="keyword">New</span> ArrayList)      <span class="comment">'对数组同步包装（仍为数组),因为这样上  </span></span><br><span class="line">        m_availableThreads = ArrayList.Synchronized(<span class="keyword">New</span> ArrayList) <span class="comment">'锁才线程安全，以防其它线程同时进行修改。  </span></span><br><span class="line">        m_debug = <span class="literal">False</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Sub</span> <span class="keyword">New</span>(<span class="keyword">ByVal</span> maxThreads <span class="keyword">As</span> <span class="built_in">Integer</span>, <span class="keyword">ByVal</span> minThreads <span class="keyword">As</span> <span class="built_in">Integer</span>, <span class="keyword">ByVal</span> maxIdleTime <span class="keyword">As</span> <span class="built_in">Integer</span>)  </span><br><span class="line">        <span class="comment">'构造函数，用3个参数实例化  </span></span><br><span class="line">        m_maxThreads = maxThreads  </span><br><span class="line">        m_minThreads = minThreads  </span><br><span class="line">        m_maxIdleTime = maxIdleTime  </span><br><span class="line">        m_pendingJobs = ArrayList.Synchronized(<span class="keyword">New</span> ArrayList)  </span><br><span class="line">        m_availableThreads = ArrayList.Synchronized(<span class="keyword">New</span> ArrayList)  </span><br><span class="line">        m_debug = <span class="literal">False</span>  </span><br><span class="line">        InitAvailableThreads()  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">Private</span> <span class="keyword">Sub</span> InitAvailableThreads() <span class="comment">'初始化线程池，分别进入池中  </span></span><br><span class="line">        <span class="keyword">If</span> m_maxThreads &gt; <span class="number">0</span> <span class="keyword">Then</span>  </span><br><span class="line">            <span class="keyword">For</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">1</span> <span class="keyword">To</span> m_maxThreads  </span><br><span class="line">                <span class="keyword">Dim</span> t <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> (<span class="keyword">New</span> GenPool(<span class="keyword">Me</span>, <span class="keyword">Me</span>)).Run)  </span><br><span class="line">                <span class="keyword">Dim</span> e <span class="keyword">As</span> <span class="keyword">New</span> ThreadElement(t)  </span><br><span class="line">                e.Idle = <span class="literal">True</span>  </span><br><span class="line">                m_availableThreads.Add(e)  </span><br><span class="line">            <span class="keyword">Next</span>  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">If</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Sub</span> <span class="keyword">New</span>(<span class="keyword">ByVal</span> maxThreads <span class="keyword">As</span> <span class="built_in">Integer</span>, <span class="keyword">ByVal</span> minThreads <span class="keyword">As</span> <span class="built_in">Integer</span>, <span class="keyword">ByVal</span> maxIdleTime <span class="keyword">As</span> <span class="built_in">Integer</span>, <span class="keyword">ByVal</span> debug <span class="keyword">As</span> <span class="built_in">Boolean</span>)  </span><br><span class="line">        <span class="comment">'构造函数，用4个参数实例化，增加调试参数  </span></span><br><span class="line">        m_maxThreads = maxThreads  </span><br><span class="line">        m_minThreads = minThreads  </span><br><span class="line">        m_maxIdleTime = maxIdleTime  </span><br><span class="line">        m_pendingJobs = ArrayList.Synchronized(<span class="keyword">New</span> ArrayList)  </span><br><span class="line">        m_availableThreads = ArrayList.Synchronized(<span class="keyword">New</span> ArrayList)  </span><br><span class="line">        m_debug = debug  </span><br><span class="line">        InitAvailableThreads()  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Function</span> GetStats() <span class="keyword">As</span> Stats <span class="keyword">Implements</span> IThreadPool.GetStats  <span class="comment">'池中状态  </span></span><br><span class="line">        <span class="keyword">Dim</span> statsInstance <span class="keyword">As</span> <span class="keyword">New</span> Stats()  </span><br><span class="line">        statsInstance.MaxThreads = m_maxThreads  </span><br><span class="line">        statsInstance.MinThreads = m_minThreads  </span><br><span class="line">        statsInstance.MaxIdleTime = m_maxIdleTime                     <span class="comment">'最大空闲时间  </span></span><br><span class="line">        statsInstance.PendingJobs = m_pendingJobs.Count               <span class="comment">'等待的作业量  </span></span><br><span class="line">        statsInstance.NumThreads = m_availableThreads.Count           <span class="comment">'有效线程数  </span></span><br><span class="line">        statsInstance.JobsInProgress = m_availableThreads.Count - FindIdleThreadCount() <span class="comment">'正在处理的作业量  </span></span><br><span class="line">        <span class="keyword">Return</span> statsInstance  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Function</span>  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Function</span> FindIdleThreadCount() <span class="keyword">As</span> <span class="built_in">Integer</span>  <span class="comment">'遍历有效线程，返回空闲线程数  </span></span><br><span class="line">        <span class="keyword">Dim</span> idleThreads <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span>  </span><br><span class="line">        <span class="keyword">For</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span> <span class="keyword">To</span> m_availableThreads.Count - <span class="number">1</span>  </span><br><span class="line">            <span class="keyword">If</span> <span class="built_in">CType</span>(m_availableThreads(i), ThreadElement).Idle <span class="keyword">Then</span> <span class="comment">'根据帮助类中的空闲标志Idle来统计  </span></span><br><span class="line">                idleThreads += <span class="number">1</span>  </span><br><span class="line">            <span class="keyword">End</span> <span class="keyword">If</span>  </span><br><span class="line">        <span class="keyword">Next</span>  </span><br><span class="line">        <span class="keyword">Return</span> idleThreads  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Function</span>  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Function</span> FindFirstIdleThread() <span class="keyword">As</span> <span class="built_in">Integer</span> <span class="comment">'遍历，找到第一个空闲线程，就立即返回其索引  </span></span><br><span class="line">        <span class="keyword">For</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span> <span class="keyword">To</span> m_availableThreads.Count - <span class="number">1</span>  </span><br><span class="line">            <span class="keyword">If</span> <span class="built_in">CType</span>(m_availableThreads(i), ThreadElement).Idle <span class="keyword">Then</span>  </span><br><span class="line">                <span class="keyword">Return</span> i  </span><br><span class="line">            <span class="keyword">End</span> <span class="keyword">If</span>  </span><br><span class="line">        <span class="keyword">Next</span>  </span><br><span class="line">        <span class="keyword">Return</span> <span class="number">-1</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Function</span>  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Function</span> FindThread() <span class="keyword">As</span> <span class="built_in">Integer</span> <span class="comment">'查找当前线程的位置(索引号)，失败为-1（说明池中无线程）  </span></span><br><span class="line">        <span class="keyword">For</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span> <span class="keyword">To</span> m_availableThreads.Count - <span class="number">1</span>  </span><br><span class="line">            <span class="keyword">If</span> <span class="built_in">CType</span>(m_availableThreads(i), ThreadElement).GetMyThread.<span class="keyword">Equals</span>(Thread.CurrentThread) <span class="keyword">Then</span>  </span><br><span class="line">                <span class="keyword">Return</span> i  </span><br><span class="line">            <span class="keyword">End</span> <span class="keyword">If</span>  </span><br><span class="line">        <span class="keyword">Next</span>  </span><br><span class="line">        <span class="keyword">Return</span> <span class="number">-1</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Function</span>  </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Sub</span> RemoveThread() <span class="comment">'移除线程  </span></span><br><span class="line">        <span class="keyword">For</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span> <span class="keyword">To</span> m_availableThreads.Count - <span class="number">1</span>  </span><br><span class="line">            <span class="keyword">If</span> <span class="built_in">CType</span>(m_availableThreads(i), ThreadElement).GetMyThread.<span class="keyword">Equals</span>(Thread.CurrentThread) <span class="keyword">Then</span>  </span><br><span class="line">                m_availableThreads.RemoveAt(i)  </span><br><span class="line">                <span class="keyword">Exit</span> <span class="keyword">Sub</span>  </span><br><span class="line">            <span class="keyword">End</span> <span class="keyword">If</span>  </span><br><span class="line">        <span class="keyword">Next</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span></span><br></pre></td></tr></table></figure>
<p><code>GenThreadPoolImpl::AddJob()</code>具体实现:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">Public Sub AddJob(ByVal job As Thread) Implements IThreadPool.AddJob '向池中添加作业  </span><br><span class="line">    If job Is Nothing Then  </span><br><span class="line">        Return  '作业不存在，退出  </span><br><span class="line">    End If  </span><br><span class="line">  </span><br><span class="line">    SyncLock Me                   '锁定GenThreadPoolImpl，防止其它线程来添加或删除作业  </span><br><span class="line">        m_pendingJobs.Add(job)    '将作业添加到 ArrayList 的结尾处。  </span><br><span class="line">        Dim index As Integer = FindFirstIdleThread()     '空闲可用线程的索引  </span><br><span class="line">        </span><br><span class="line">        If m_debug Then  </span><br><span class="line">            Console.WriteLine("First Idle Thread Is " &amp; index.ToString)  </span><br><span class="line">        End If  </span><br><span class="line">  </span><br><span class="line">        If index = -1 Then        '-1无空闲线程，故需创建新的线程  </span><br><span class="line">            If m_maxThreads = -1 Or m_availableThreads.Count &lt; m_maxThreads Then  </span><br><span class="line">                '池中无线程，或在用（有效）线程还未达最大线程数限制---&gt;创建线程  </span><br><span class="line">                If m_debug Then  </span><br><span class="line">                    Console.WriteLine("Creating a New thread")  </span><br><span class="line">                End If  </span><br><span class="line">  </span><br><span class="line">                Dim t As New Thread(AddressOf (New GenPool(Me, Me)).Run)  </span><br><span class="line">                Dim e As New ThreadElement(t) '帮助类，提供线程额外属性  </span><br><span class="line">                e.Idle = False  </span><br><span class="line">                e.GetMyThread.Start()         '线程添加到ArrayList数组前先激发  </span><br><span class="line">  </span><br><span class="line">                Try                           '添加  </span><br><span class="line">                    m_availableThreads.Add(e)  </span><br><span class="line">                Catch ex As OutOfMemoryException  </span><br><span class="line">                    Console.WriteLine("Out Of memory: " &amp; ex.ToString)  </span><br><span class="line">                    Thread.Sleep(3000)  </span><br><span class="line">                    m_availableThreads.Add(e)  </span><br><span class="line">                    Console.WriteLine("Added Job again")  </span><br><span class="line">                End Try  </span><br><span class="line">                </span><br><span class="line">                Return  </span><br><span class="line">            End If  </span><br><span class="line">  </span><br><span class="line">            If m_debug Then  </span><br><span class="line">                Console.WriteLine("No Threads Available...” &amp; GetStats.ToString)  </span><br><span class="line">            End If  </span><br><span class="line">        Else  '池中找到有空的线程  </span><br><span class="line">            Try  </span><br><span class="line">                If m_debug Then  </span><br><span class="line">                    Console.WriteLine("Using an existing thread...")  </span><br><span class="line">                End If  </span><br><span class="line">  </span><br><span class="line">                CType(m_availableThreads(index), ThreadElement).Idle = False   '标注忙碌  </span><br><span class="line">                SyncLock CType(m_availableThreads(index), ThreadElement).GetMyThread()  </span><br><span class="line">                    Monitor.Pulse(CType(m_availableThreads(index), ThreadElement).GetMyThread())  </span><br><span class="line">                End SyncLock  </span><br><span class="line">            Catch ex As Exception  </span><br><span class="line">                Console.WriteLine(("Error while reusing thread " &amp; ex.Message))  </span><br><span class="line">                If m_debug Then  </span><br><span class="line">                    Console.WriteLine("Value of index Is " &amp; index.ToString)  </span><br><span class="line">                    Console.WriteLine("Size of available threads Is " &amp; m_availableThreads.Count.ToString)  </span><br><span class="line">                    Console.WriteLine("Available Threads Is " &amp; m_availableThreads.IsSynchronized.ToString)  </span><br><span class="line">                End If  </span><br><span class="line">            End Try  </span><br><span class="line">        End If  </span><br><span class="line">    End SyncLock  </span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Public</span> <span class="keyword">Class</span> GenPool <span class="comment">'执行线程类（执行完毕后，过了指定超时时限，将自动从池中删除）  </span></span><br><span class="line">    <span class="keyword">Private</span> m_lock <span class="keyword">As</span> <span class="built_in">Object</span>           <span class="comment">'锁定对象  </span></span><br><span class="line">    <span class="keyword">Private</span> m_gn <span class="keyword">As</span> GenThreadPoolImpl  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Sub</span> <span class="keyword">New</span>(lock_ <span class="keyword">As</span> <span class="built_in">Object</span>, gn <span class="keyword">As</span> GenThreadPoolImpl)  </span><br><span class="line">        m_lock = lock_  </span><br><span class="line">        m_gn = gn  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Sub</span> Run() <span class="comment">'循环运行并检测是否过期  </span></span><br><span class="line">        <span class="keyword">Dim</span> job <span class="keyword">As</span> Thread  </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">While</span> <span class="literal">True</span> <span class="comment">'无限循环，一直检查池中状态  </span></span><br><span class="line">            <span class="keyword">While</span> <span class="literal">True</span>  </span><br><span class="line">                <span class="keyword">SyncLock</span> m_lock  </span><br><span class="line">                    <span class="keyword">If</span> m_gn.PendingJobs.Count = <span class="number">0</span> <span class="keyword">Then</span>           <span class="comment">'后续无作业进来  </span></span><br><span class="line">                        <span class="keyword">Dim</span> index <span class="keyword">As</span> <span class="built_in">Integer</span> = m_gn.FindThread() <span class="comment">'取当前线程索引号  </span></span><br><span class="line">                        <span class="keyword">If</span> index = <span class="number">-1</span> <span class="keyword">Then</span>               <span class="comment">'无作业，池中也无线程，退出  </span></span><br><span class="line">                            <span class="keyword">Exit</span> <span class="keyword">Sub</span>  </span><br><span class="line">                        <span class="keyword">End</span> <span class="keyword">If</span>                                 <span class="comment">'无作业，新的线程设为空闲  </span></span><br><span class="line">                        <span class="built_in">CType</span>(m_gn.AvailableThreads(index), ThreadElement).Idle = <span class="literal">True</span>  </span><br><span class="line">                        <span class="keyword">Exit</span> <span class="keyword">While</span>  </span><br><span class="line">                    <span class="keyword">End</span> <span class="keyword">If</span>  </span><br><span class="line">                    </span><br><span class="line">                    job = <span class="built_in">CType</span>(m_gn.PendingJobs(<span class="number">0</span>), Thread) <span class="comment">'有作业，取出（从原作业数组中删除)  </span></span><br><span class="line">                    m_gn.PendingJobs.RemoveAt(<span class="number">0</span>)  </span><br><span class="line">                <span class="keyword">End</span> <span class="keyword">SyncLock</span>  </span><br><span class="line">                </span><br><span class="line">                job.Start()             <span class="comment">'作业执行启动  </span></span><br><span class="line">            <span class="keyword">End</span> <span class="keyword">While</span>  </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">Try</span>   <span class="comment">'无后续作业  </span></span><br><span class="line">                <span class="keyword">SyncLock</span> <span class="keyword">Me</span>  </span><br><span class="line">                    <span class="keyword">If</span> m_gn.MaxIdleTime = <span class="number">-1</span> <span class="keyword">Then</span> <span class="comment">'池中无空闲线程，阻塞等待  </span></span><br><span class="line">                        Monitor.Wait(<span class="keyword">Me</span>)  </span><br><span class="line">                    <span class="keyword">Else</span>  </span><br><span class="line">                        Monitor.Wait(<span class="keyword">Me</span>, m_gn.MaxIdleTime)  </span><br><span class="line">                    <span class="keyword">End</span> <span class="keyword">If</span>  </span><br><span class="line">                <span class="keyword">End</span> <span class="keyword">SyncLock</span>  </span><br><span class="line">            <span class="keyword">Catch</span>  </span><br><span class="line">            <span class="keyword">End</span> <span class="keyword">Try</span>  </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">SyncLock</span> m_lock  </span><br><span class="line">                <span class="keyword">If</span> m_gn.PendingJobs.Count = <span class="number">0</span> <span class="keyword">Then</span> <span class="comment">'无等待的作业(没有新的作业进来）  </span></span><br><span class="line">                    <span class="keyword">If</span> m_gn.MinThreads &lt;&gt; <span class="number">-1</span> <span class="keyword">And</span> m_gn.AvailableThreads.Count &gt; m_gn.MinThreads <span class="keyword">Then</span>  </span><br><span class="line">                        m_gn.RemoveThread() <span class="comment">'池中线程不空，且有效线程大于最小线程，删除线程  </span></span><br><span class="line">                        <span class="keyword">Return</span>  </span><br><span class="line">                    <span class="keyword">End</span> <span class="keyword">If</span>  </span><br><span class="line">                <span class="keyword">End</span> <span class="keyword">If</span>  </span><br><span class="line">            <span class="keyword">End</span> <span class="keyword">SyncLock</span>  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">While</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span></span><br></pre></td></tr></table></figure>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Public</span> <span class="keyword">Class</span> ThreadElement <span class="comment">'对应线程的线程帮助类（以例为之设计空闲标志，获取引用）  </span></span><br><span class="line">    <span class="keyword">Private</span> m_idle <span class="keyword">As</span> <span class="built_in">Boolean</span>   <span class="comment">'空闲线程标志  </span></span><br><span class="line">    <span class="keyword">Private</span> m_thread <span class="keyword">As</span> Thread</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Sub</span> <span class="keyword">New</span>(th <span class="keyword">As</span> Thread)  </span><br><span class="line">        m_thread = th  </span><br><span class="line">        m_idle = <span class="literal">True</span>      <span class="comment">'初始化即为空闲  </span></span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Property</span> Idle() <span class="keyword">As</span> <span class="built_in">Boolean</span> <span class="comment">'设置或获取线程空闲标志  </span></span><br><span class="line">        <span class="keyword">Get</span>  </span><br><span class="line">            <span class="keyword">Return</span> m_idle  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Get</span>  </span><br><span class="line">        <span class="keyword">Set</span>  </span><br><span class="line">            m_idle = Value  </span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Set</span>  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Property</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Function</span> GetMyThread() <span class="keyword">As</span> Thread <span class="comment">'取得原线程  </span></span><br><span class="line">        <span class="keyword">Return</span> m_thread  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Function</span>  </span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">Public</span> <span class="keyword">Structure</span> Stats  <span class="comment">'状态统计</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Public</span> MaxThreads <span class="keyword">As</span> <span class="built_in">Integer</span>  </span><br><span class="line">    <span class="keyword">Public</span> MinThreads <span class="keyword">As</span> <span class="built_in">Integer</span>  </span><br><span class="line">    <span class="keyword">Public</span> MaxIdleTime <span class="keyword">As</span> <span class="built_in">Integer</span>  </span><br><span class="line">    <span class="keyword">Public</span> NumThreads <span class="keyword">As</span> <span class="built_in">Integer</span>  </span><br><span class="line">    <span class="keyword">Public</span> PendingJobs <span class="keyword">As</span> <span class="built_in">Integer</span>     <span class="comment">'列队等待的作业量  </span></span><br><span class="line">    <span class="keyword">Public</span> JobsInProgress <span class="keyword">As</span> <span class="built_in">Integer</span>  <span class="comment">'正在处理的作业量</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Overrides</span> <span class="keyword">Function</span> ToString() <span class="keyword">As</span> <span class="built_in">String</span>        <span class="comment">'提取状态  </span></span><br><span class="line">        <span class="keyword">Dim</span> sb <span class="keyword">As</span> <span class="keyword">New</span> StringBuilder(<span class="string">"MaxThreads = "</span>, <span class="number">107</span>) <span class="comment">'容量大小107字符  </span></span><br><span class="line">        sb.Append(MaxThreads)  </span><br><span class="line">        sb.Append(ControlChars.Lf &amp; <span class="string">"MinThreads="</span> &amp; MinThreads)  </span><br><span class="line">        sb.Append(ControlChars.Lf &amp; <span class="string">"MaxIdleTime="</span> &amp; MaxIdleTime)  </span><br><span class="line">        sb.Append(ControlChars.Lf &amp; <span class="string">"PendingJobs="</span> &amp; PendingJobs)  </span><br><span class="line">        sb.Append(ControlChars.Lf &amp; <span class="string">"JobsInProgress="</span> &amp; JobsInProgress）  </span><br><span class="line">        <span class="keyword">Return</span> sb.ToString  </span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Structure</span></span><br></pre></td></tr></table></figure>
<p>然后，完成主程序代码，用来测试：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">Imports System.Threading</span><br><span class="line"></span><br><span class="line">Namespace TestGenThreadPool</span><br><span class="line"></span><br><span class="line">    Public Class TestPerformance</span><br><span class="line">    </span><br><span class="line">        Public count As Integer  </span><br><span class="line">        Private m_lock As New Object()  </span><br><span class="line">  </span><br><span class="line">        Public Sub New(pool As GenThreadPool.IThreadPool, times As Integer)  </span><br><span class="line">            Console.WriteLine("Performance using Pool [in ms]: ")  </span><br><span class="line">            count = 0  </span><br><span class="line">            Dim start As Long = Now.Millisecond  </span><br><span class="line">            Console.WriteLine("Start Time For Job Is " &amp; Now)  </span><br><span class="line">            Dim i As Integer  </span><br><span class="line">            For i = 0 To times - 1  </span><br><span class="line">                Dim tl As New Thread(AddressOf (New Job(Me)).Run)  </span><br><span class="line">                pool.AddJob(tl)  </span><br><span class="line">            Next  </span><br><span class="line">  </span><br><span class="line">            While True  </span><br><span class="line">                SyncLock m_lock  </span><br><span class="line">                    If count = times Then  </span><br><span class="line">                        Exit While  </span><br><span class="line">                    End If  </span><br><span class="line">                End SyncLock  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">                Try  </span><br><span class="line">                    Thread.Sleep(5000)  </span><br><span class="line">                Catch  </span><br><span class="line">                End Try  </span><br><span class="line">            End While  </span><br><span class="line">  </span><br><span class="line">            Console.WriteLine(" " &amp; (Now.Millisecond - start).ToString)  </span><br><span class="line">            Console.WriteLine("End Time for Job is " &amp; Now.ToString)  </span><br><span class="line">            Console.WriteLine("Performance using no Pool [in ms]: ")  </span><br><span class="line">            count = 0  </span><br><span class="line">            start = Now.Millisecond  </span><br><span class="line">            Console.WriteLine("Start Time for JobThread is " &amp; Now.ToString)  </span><br><span class="line">            For i = 0 To times - 1  </span><br><span class="line">                Dim jt As New Thread(AddressOf (New JobThread(Me)).Run)  </span><br><span class="line">                jt.Start()  </span><br><span class="line">            Next  </span><br><span class="line">  </span><br><span class="line">            While True  </span><br><span class="line">                SyncLock m_lock  </span><br><span class="line">                    If count = times Then  </span><br><span class="line">                        Exit While  </span><br><span class="line">                    End If  </span><br><span class="line">                End SyncLock  </span><br><span class="line">                Try  </span><br><span class="line">                    Thread.Sleep(5000)  </span><br><span class="line">                Catch  </span><br><span class="line">                End Try  </span><br><span class="line">            End While  </span><br><span class="line">            Console.WriteLine(" " &amp; (Now.Millisecond - start).ToString())  </span><br><span class="line">            Console.WriteLine("End Time for JobThread is ” &amp; Now.ToString)  </span><br><span class="line">        End Sub  </span><br><span class="line">    End Class</span><br><span class="line"></span><br><span class="line">    ' ...</span><br><span class="line">End Namespace</span><br></pre></td></tr></table></figure>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">NotInheritable</span> <span class="keyword">Class</span> JobThread  </span><br><span class="line">   <span class="keyword">Private</span> m_lock <span class="keyword">As</span> <span class="keyword">New</span> <span class="built_in">Object</span>()  </span><br><span class="line">   <span class="keyword">Private</span> tpf <span class="keyword">As</span> TestPerformance  </span><br><span class="line">   </span><br><span class="line">   <span class="keyword">Public</span> <span class="keyword">Sub</span> <span class="keyword">New</span>(tpf_ <span class="keyword">As</span> TestPerformance)  </span><br><span class="line">       tpf = tpf_  </span><br><span class="line">   <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line"></span><br><span class="line">   <span class="keyword">Public</span> <span class="keyword">Sub</span> Run()  </span><br><span class="line">       <span class="keyword">SyncLock</span> m_lock  </span><br><span class="line">           tpf.count += <span class="number">1</span>  </span><br><span class="line">       <span class="keyword">End</span> <span class="keyword">SyncLock</span>  </span><br><span class="line">   <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span>  </span><br><span class="line"></span><br><span class="line"><span class="keyword">NotInheritable</span> <span class="keyword">Class</span> Job  </span><br><span class="line"></span><br><span class="line">   <span class="keyword">Private</span> m_lock <span class="keyword">As</span> <span class="keyword">New</span> <span class="built_in">Object</span>()  </span><br><span class="line">   <span class="keyword">Private</span> tpf <span class="keyword">As</span> TestPerformance  </span><br><span class="line">  </span><br><span class="line">   <span class="keyword">Public</span> <span class="keyword">Sub</span> <span class="keyword">New</span>(tpf_ <span class="keyword">As</span> TestPerformance)  </span><br><span class="line">       tpf = tpf_  </span><br><span class="line">   <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line">   </span><br><span class="line">   <span class="keyword">Public</span> <span class="keyword">Sub</span> Run()  </span><br><span class="line">       <span class="keyword">SyncLock</span> m_lock  </span><br><span class="line">           tpf.count += <span class="number">1</span>  </span><br><span class="line">       <span class="keyword">End</span> <span class="keyword">SyncLock</span>  </span><br><span class="line">   <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span></span><br></pre></td></tr></table></figure>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Class</span> TestPool</span><br><span class="line"></span><br><span class="line">   <span class="keyword">Private</span> <span class="keyword">Shared</span> i <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span>  </span><br><span class="line">   <span class="keyword">Private</span> j <span class="keyword">As</span> <span class="built_in">Integer</span> = <span class="number">0</span>  </span><br><span class="line">   <span class="keyword">Public</span> <span class="keyword">Sub</span> Run()  </span><br><span class="line">       i += <span class="number">1</span>  </span><br><span class="line">       j = i  </span><br><span class="line">       Console.WriteLine(<span class="string">"Value of i in run is &#123;0&#125; "</span>, j)  </span><br><span class="line">   <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line"></span><br><span class="line">   <span class="keyword">Public</span> <span class="keyword">Shared</span> <span class="keyword">Sub</span> Main(args() <span class="keyword">As</span> <span class="built_in">String</span>)  </span><br><span class="line">       <span class="keyword">Dim</span> tp = <span class="keyword">New</span> GenThreadPool.GenThreadPoolImpl(<span class="number">1000</span>, <span class="number">1000</span>, <span class="number">300</span>, <span class="literal">True</span>)  </span><br><span class="line">       <span class="keyword">Dim</span> i <span class="keyword">As</span> <span class="built_in">Integer</span>  </span><br><span class="line">       </span><br><span class="line">       <span class="keyword">For</span> i = <span class="number">0</span> <span class="keyword">To</span> <span class="number">99</span> <span class="comment">'添加作业到线程池管理器  </span></span><br><span class="line">           <span class="keyword">Dim</span> td1 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t1 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td1.Run)  </span><br><span class="line">           <span class="keyword">Dim</span> td2 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t2 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td2.Run)  </span><br><span class="line">           <span class="keyword">Dim</span> td3 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t3 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td3.Run)  </span><br><span class="line">           <span class="keyword">Dim</span> td4 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t4 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td4.Run)  </span><br><span class="line">           <span class="keyword">Dim</span> td5 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t5 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td5.Run)  </span><br><span class="line">           <span class="keyword">Dim</span> td6 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t6 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td6.Run)  </span><br><span class="line">           <span class="keyword">Dim</span> td7 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t7 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td7.Run)  </span><br><span class="line">           <span class="keyword">Dim</span> td8 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t8 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td8.Run)  </span><br><span class="line">           <span class="keyword">Dim</span> td9 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t9 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td9.Run)  </span><br><span class="line">           <span class="keyword">Dim</span> td10 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t10 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td10.Run)  </span><br><span class="line">           <span class="keyword">Dim</span> td11 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">           <span class="keyword">Dim</span> t11 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td11.Run)  </span><br><span class="line">           tp.AddJob(t1)  </span><br><span class="line">           tp.AddJob(t2)  </span><br><span class="line">           tp.AddJob(t3)  </span><br><span class="line">           tp.AddJob(t4)  </span><br><span class="line">           tp.AddJob(t5)  </span><br><span class="line">           tp.AddJob(t6)  </span><br><span class="line">           tp.AddJob(t7)  </span><br><span class="line">           tp.AddJob(t8)  </span><br><span class="line">           tp.AddJob(t9)  </span><br><span class="line">           tp.AddJob(t10)  </span><br><span class="line">           tp.AddJob(t11)  </span><br><span class="line">       <span class="keyword">Next</span>  </span><br><span class="line">       </span><br><span class="line">       <span class="keyword">Dim</span> td12 <span class="keyword">As</span> <span class="keyword">New</span> TestPool  </span><br><span class="line">       <span class="keyword">Dim</span> t12 <span class="keyword">As</span> <span class="keyword">New</span> Thread(<span class="keyword">AddressOf</span> td12.Run)  </span><br><span class="line">       tp.AddJob(t12)  </span><br><span class="line">       <span class="keyword">Dim</span> p <span class="keyword">As</span> <span class="keyword">New</span> TestPerformance(tp, <span class="number">1000</span>)  </span><br><span class="line">   <span class="keyword">End</span> <span class="keyword">Sub</span>  </span><br><span class="line">   <span class="keyword">End</span> <span class="keyword">Class</span>  </span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Namespace</span></span><br></pre></td></tr></table></figure>
<p>结果较长，同时播放视频时，就可明显感觉到视频有点卡顿，说明CPU有点忙不过来了：）</p>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/vbnet/threadpool/20160616102959250.png" alt=""></p>
<blockquote>
<p><img src="https://raw.githubusercontent.com/xieguigang/xieguigang.github.io-hexo/master/images/qrcode/vbnet_threadpool.png" alt="VB.net学习笔记（三十）认识线程池"></p>
</blockquote>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://blog.xieguigang.me/2016/08/13/vbnet_threadpool/" data-id="cirtav7520000asv437dp6ftn" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    
        <a href="http://blog.xieguigang.me/2016/08/13/vbnet_threadpool/#comments" class="article-comment-link disqus-comment-count" data-disqus-url="http://blog.xieguigang.me/2016/08/13/vbnet_threadpool/">评论</a>
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2016/08/13/d3js_datelines/" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    D3.js制作日期折线图
                
            </div>
        </a>
    
    
        <a href="/2016/08/09/chinese_language_not_so_strong/" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">汉语对现代文明的贡献有多大</div>
        </a>
    
</nav>


    
</article>


    
    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>

</section>
            
                <aside id="sidebar">
   
        
    
        
    <div class="widget-wrap">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">22</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/3D/" style="font-size: 10px;">3D</a> <a href="/tags/3d/" style="font-size: 10px;">3d</a> <a href="/tags/3d-graphics/" style="font-size: 10px;">3d graphics</a> <a href="/tags/BI/" style="font-size: 10px;">BI</a> <a href="/tags/Chinese/" style="font-size: 10px;">Chinese</a> <a href="/tags/Chinese-rural-dog/" style="font-size: 10px;">Chinese rural dog</a> <a href="/tags/CodeProject/" style="font-size: 15px;">CodeProject</a> <a href="/tags/Compiler/" style="font-size: 10px;">Compiler</a> <a href="/tags/Desktop/" style="font-size: 10px;">Desktop</a> <a href="/tags/Enigma/" style="font-size: 13.33px;">Enigma</a> <a href="/tags/GCModeller/" style="font-size: 11.67px;">GCModeller</a> <a href="/tags/IE/" style="font-size: 10px;">IE</a> <a href="/tags/Linq/" style="font-size: 10px;">Linq</a> <a href="/tags/MSDN/" style="font-size: 10px;">MSDN</a> <a href="/tags/Markdown/" style="font-size: 10px;">Markdown</a> <a href="/tags/PDB/" style="font-size: 10px;">PDB</a> <a href="/tags/R/" style="font-size: 10px;">R</a> <a href="/tags/SDK-document/" style="font-size: 10px;">SDK document</a> <a href="/tags/SVG/" style="font-size: 10px;">SVG</a> <a href="/tags/Syntax/" style="font-size: 10px;">Syntax</a> <a href="/tags/UI/" style="font-size: 10px;">UI</a> <a href="/tags/VisualStudio/" style="font-size: 10px;">VisualStudio</a> <a href="/tags/WPF/" style="font-size: 10px;">WPF</a> <a href="/tags/XAML/" style="font-size: 10px;">XAML</a> <a href="/tags/YAML/" style="font-size: 10px;">YAML</a> <a href="/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/tags/architecture/" style="font-size: 11.67px;">architecture</a> <a href="/tags/art-work/" style="font-size: 10px;">art work</a> <a href="/tags/async/" style="font-size: 10px;">async</a> <a href="/tags/bash/" style="font-size: 10px;">bash</a> <a href="/tags/check-point/" style="font-size: 10px;">check-point</a> <a href="/tags/chrome/" style="font-size: 10px;">chrome</a> <a href="/tags/circos/" style="font-size: 11.67px;">circos</a> <a href="/tags/d3js/" style="font-size: 13.33px;">d3js</a> <a href="/tags/data-analysis/" style="font-size: 10px;">data analysis</a> <a href="/tags/data-visualization/" style="font-size: 10px;">data visualization</a> <a href="/tags/desktop/" style="font-size: 10px;">desktop</a> <a href="/tags/document/" style="font-size: 10px;">document</a> <a href="/tags/elementary-os/" style="font-size: 10px;">elementary os</a> <a href="/tags/firefox/" style="font-size: 10px;">firefox</a> <a href="/tags/force-directed/" style="font-size: 10px;">force directed</a> <a href="/tags/gdi/" style="font-size: 11.67px;">gdi+</a> <a href="/tags/genetics/" style="font-size: 10px;">genetics</a> <a href="/tags/github/" style="font-size: 13.33px;">github</a> <a href="/tags/interface/" style="font-size: 10px;">interface</a> <a href="/tags/javascript/" style="font-size: 16.67px;">javascript</a> <a href="/tags/jquery/" style="font-size: 10px;">jquery</a> <a href="/tags/language/" style="font-size: 10px;">language</a> <a href="/tags/languages/" style="font-size: 10px;">languages</a> <a href="/tags/libzplay/" style="font-size: 10px;">libzplay</a> <a href="/tags/math/" style="font-size: 10px;">math</a> <a href="/tags/music/" style="font-size: 16.67px;">music</a> <a href="/tags/my-works/" style="font-size: 10px;">my works</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/note/" style="font-size: 18.33px;">note</a> <a href="/tags/open-source/" style="font-size: 10px;">open-source</a> <a href="/tags/perl/" style="font-size: 10px;">perl</a> <a href="/tags/re0/" style="font-size: 10px;">re0</a> <a href="/tags/rem/" style="font-size: 10px;">rem</a> <a href="/tags/repost/" style="font-size: 16.67px;">repost</a> <a href="/tags/statics/" style="font-size: 10px;">statics</a> <a href="/tags/svg/" style="font-size: 10px;">svg</a> <a href="/tags/threading/" style="font-size: 10px;">threading</a> <a href="/tags/threadpool/" style="font-size: 10px;">threadpool</a> <a href="/tags/tricks/" style="font-size: 10px;">tricks</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/user-agent/" style="font-size: 10px;">user-agent</a> <a href="/tags/vb-net/" style="font-size: 20px;">vb.net</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/web-server/" style="font-size: 10px;">web server</a> <a href="/tags/win10/" style="font-size: 10px;">win10</a> <a href="/tags/works/" style="font-size: 10px;">works</a> <a href="/tags/中華田園犬/" style="font-size: 10px;">中華田園犬</a> <a href="/tags/前端/" style="font-size: 10px;">前端</a> <a href="/tags/前端设计/" style="font-size: 13.33px;">前端设计</a> <a href="/tags/数据视图/" style="font-size: 10px;">数据视图</a> <a href="/tags/架构/" style="font-size: 11.67px;">架构</a> <a href="/tags/架构设计/" style="font-size: 10px;">架构设计</a> <a href="/tags/线程池/" style="font-size: 10px;">线程池</a> <a href="/tags/转载/" style="font-size: 10px;">转载</a> <a href="/tags/转载搬运/" style="font-size: 16.67px;">转载搬运</a> <a href="/tags/鹿乃/" style="font-size: 10px;">鹿乃</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://framework-docs.xieguigang.me/">VisualBasic Framework</a>
                    </li>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
                    <li>
                        <a href="http://gcmodeller.org">http://gcmodeller.org</a>
                    </li>
                
                    <li>
                        <a href="https://github.com/genetics-potato">https://github.com/genetics-potato</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>
            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2016 しゃけい よしつな<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_config = function () {
        
            this.page.url = 'http://blog.xieguigang.me/2016/08/13/vbnet_threadpool/';
        
        this.page.identifier = 'vbnet_threadpool';
    };
    (function() { 
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'xieguigang' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>



    
        <script src="/vendor/fancybox/jquery.fancybox.pack.js"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>